<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Great Inversion Simulator - Ethics Beyond Boundaries</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .controls {
            background: #f8f9fa;
            padding: 25px;
            border-bottom: 3px solid #dee2e6;
        }

        .control-row {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        .btn-secondary {
            background: #2196F3;
            color: white;
        }

        .btn-secondary:hover {
            background: #0b7dda;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #da190b;
        }

        .split-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 600px;
        }

        .panel {
            padding: 30px;
            overflow-y: auto;
        }

        .panel-china {
            background: #fff3e0;
            border-right: 3px solid #ff9800;
        }

        .panel-us {
            background: #e3f2fd;
        }

        .panel h2 {
            font-size: 2em;
            margin-bottom: 20px;
            text-align: center;
        }

        .panel-china h2 {
            color: #e65100;
        }

        .panel-us h2 {
            color: #0d47a1;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #333;
            background: rgba(0,0,0,0.05);
        }

        .tab.active {
            color: #2196F3;
            border-bottom-color: #2196F3;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 20px 0;
        }

        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .metric-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-change {
            font-size: 14px;
            font-weight: 600;
        }

        .metric-change.positive {
            color: #4CAF50;
        }

        .metric-change.negative {
            color: #f44336;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .comparison-section {
            padding: 30px;
            background: #f5f5f5;
        }

        .comparison-table {
            width: 100%;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .comparison-table th,
        .comparison-table td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }

        .comparison-table th {
            background: #2196F3;
            color: white;
            font-weight: 600;
        }

        .comparison-table td:first-child {
            text-align: left;
            font-weight: 600;
        }

        .timeline {
            margin: 30px 0;
            padding: 20px;
            background: white;
            border-radius: 12px;
        }

        .timeline-slider {
            width: 100%;
            margin: 20px 0;
        }

        .agent-story {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 4px solid #2196F3;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .agent-story h4 {
            color: #2196F3;
            margin-bottom: 15px;
        }

        .story-event {
            padding: 10px;
            margin: 10px 0;
            border-left: 3px solid #ddd;
            padding-left: 15px;
        }

        .coherence-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 10px;
        }

        .coherence-high {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .coherence-medium {
            background: #fff9c4;
            color: #f57f17;
        }

        .coherence-low {
            background: #ffcdd2;
            color: #c62828;
        }

        .reflection-section {
            padding: 30px;
            background: #e8f5e9;
        }

        .reflection-question {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .reflection-question h4 {
            color: #2e7d32;
            margin-bottom: 10px;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
        }

        textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .info-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .info-box strong {
            color: #f57f17;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-running {
            background: #4CAF50;
            animation: pulse 1.5s infinite;
        }

        .status-paused {
            background: #ff9800;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @media (max-width: 1200px) {
            .split-view {
                grid-template-columns: 1fr;
            }
            
            .panel-china {
                border-right: none;
                border-bottom: 3px solid #ff9800;
            }
        }

        .heatmap {
            display: grid;
            grid-template-rows: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .heatmap-row {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 10px;
            align-items: center;
        }

        .heatmap-label {
            font-weight: 600;
            color: #333;
        }

        .heatmap-bars {
            display: flex;
            gap: 2px;
            height: 30px;
        }

        .heatmap-bar {
            flex: 1;
            background: #ddd;
            transition: background 0.3s;
        }

        .heatmap-bar.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .debt-tracker {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .debt-bar-container {
            margin: 15px 0;
        }

        .debt-bar {
            height: 40px;
            background: #ffebee;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .debt-level {
            height: 100%;
            background: linear-gradient(90deg, #ef5350, #e53935);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            padding: 0 15px;
            color: white;
            font-weight: bold;
        }

        .fidelity-gauge {
            text-align: center;
            padding: 30px;
        }

        .gauge-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: bold;
            color: white;
            position: relative;
            background: conic-gradient(from 0deg, #4CAF50 0%, #4CAF50 var(--percentage), #ddd var(--percentage));
        }

        .gauge-inner {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .gauge-value {
            font-size: 48px;
            font-weight: bold;
            color: #333;
        }

        .gauge-label {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåê The Great Inversion Simulator</h1>
            <p>Metabolic vs. Extractive Capitalism: China & United States (1973-2024)</p>
        </div>

        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <span class="status-indicator" id="statusIndicator"></span>
                    <strong>Status:</strong>
                    <span id="statusText">Ready</span>
                </div>
                <div class="control-group">
                    <button class="btn-primary" id="runBtn" onclick="runSimulation()">‚ñ∂ Run Simulation</button>
                    <button class="btn-secondary" id="pauseBtn" onclick="pauseSimulation()" disabled>‚è∏ Pause</button>
                    <button class="btn-danger" onclick="resetSimulation()">‚Üª Reset</button>
                </div>
            </div>
            <div class="control-row">
                <div class="control-group">
                    <label><strong>Time Period:</strong></label>
                    <input type="range" id="yearSlider" class="timeline-slider" min="0" max="51" value="0" disabled>
                    <span id="currentYear">1973</span>
                </div>
                <div class="control-group">
                    <label><strong>Speed:</strong></label>
                    <select id="speedSelect">
                        <option value="1000">1x</option>
                        <option value="500" selected>2x</option>
                        <option value="200">5x</option>
                        <option value="100">10x</option>
                    </select>
                </div>
            </div>
            <div class="info-box">
                <strong>About this simulation:</strong> Watch as identical starting populations experience opposite trajectories based on institutional design. China uses capitalism metabolically (supporting coherence), while the US uses it extractively (damaging coherence). The Morphic Constraint principle shows why the same mechanisms produce different outcomes.
            </div>
        </div>

        <div class="split-view">
            <!-- CHINA PANEL -->
            <div class="panel panel-china">
                <h2>üá®üá≥ China: Metabolic Capitalism</h2>
                
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('china', 0)">Coherence</button>
                    <button class="tab" onclick="switchTab('china', 1)">Repair Loops</button>
                    <button class="tab" onclick="switchTab('china', 2)">Metrics</button>
                    <button class="tab" onclick="switchTab('china', 3)">Agent Story</button>
                </div>

                <div class="tab-content active" id="china-tab-0">
                    <div class="chart-container">
                        <canvas id="chinaCoherenceChart"></canvas>
                    </div>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Average Coherence</div>
                            <div class="metric-value" id="chinaAvgCoherence">0.15</div>
                            <div class="metric-change" id="chinaCoherenceChange">Starting...</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Population Below Threshold</div>
                            <div class="metric-value" id="chinaBelowThreshold">88%</div>
                            <div class="metric-change" id="chinaThresholdChange">Initial state</div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="china-tab-1">
                    <h3>Repair Loop Activations</h3>
                    <div class="heatmap">
                        <div class="heatmap-row">
                            <div class="heatmap-label">Institutional</div>
                            <div class="heatmap-bars" id="chinaInstitutionalBars"></div>
                        </div>
                        <div class="heatmap-row">
                            <div class="heatmap-label">Civic</div>
                            <div class="heatmap-bars" id="chinaCivicBars"></div>
                        </div>
                        <div class="heatmap-row">
                            <div class="heatmap-label">BioBond</div>
                            <div class="heatmap-bars" id="chinaBioBondBars"></div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Total Repair Activations</div>
                        <div class="metric-value" id="chinaRepairCount">0</div>
                        <div class="metric-change positive">Active repair system</div>
                    </div>
                </div>

                <div class="tab-content" id="china-tab-2">
                    <h3>Key Outcome Metrics</h3>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Life Expectancy</div>
                            <div class="metric-value" id="chinaLifeExpectancy">66</div>
                            <div class="metric-change" id="chinaLifeChange">years</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Poverty Rate</div>
                            <div class="metric-value" id="chinaPoverty">88%</div>
                            <div class="metric-change" id="chinaPovertyChange">(&lt;$1.90/day)</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Home Ownership</div>
                            <div class="metric-value" id="chinaHomeOwnership">~0%</div>
                            <div class="metric-change" id="chinaHomeChange">collectivized</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Optimism Index</div>
                            <div class="metric-value" id="chinaOptimism">--</div>
                            <div class="metric-change" id="chinaOptimismChange">recovering from trauma</div>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 30px;">Morphic Fidelity</h3>
                    <div class="fidelity-gauge">
                        <div class="gauge-circle" id="chinaFidelityGauge" style="--percentage: 0%">
                            <div class="gauge-inner">
                                <div class="gauge-value" id="chinaFidelityValue">0%</div>
                                <div class="gauge-label">Pattern Match</div>
                            </div>
                        </div>
                        <p><strong>Policy shape matches population need shape</strong></p>
                    </div>
                </div>

                <div class="tab-content" id="china-tab-3">
                    <div class="agent-story">
                        <h4>Agent #47: Wang Li (Rural ‚Üí Urban)</h4>
                        <div id="chinaAgentStory">
                            <div class="story-event">
                                <strong>1978:</strong> Subsistence farmer, Anhui Province
                                <span class="coherence-badge coherence-low">Coherence: 0.12</span>
                                <p style="margin-top: 5px; color: #666;">Barely surviving, widespread hunger</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- US PANEL -->
            <div class="panel panel-us">
                <h2>üá∫üá∏ United States: Extractive Capitalism</h2>
                
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('us', 0)">Coherence</button>
                    <button class="tab" onclick="switchTab('us', 1)">Repair Loops</button>
                    <button class="tab" onclick="switchTab('us', 2)">Metrics</button>
                    <button class="tab" onclick="switchTab('us', 3)">Agent Story</button>
                </div>

                <div class="tab-content active" id="us-tab-0">
                    <div class="chart-container">
                        <canvas id="usCoherenceChart"></canvas>
                    </div>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Average Coherence</div>
                            <div class="metric-value" id="usAvgCoherence">0.70</div>
                            <div class="metric-change" id="usCoherenceChange">Starting...</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Bottom 50% Coherence</div>
                            <div class="metric-value" id="usBottom50">0.68</div>
                            <div class="metric-change" id="usBottom50Change">Stable middle class</div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="us-tab-1">
                    <h3>Repair Loop Activations</h3>
                    <div class="heatmap">
                        <div class="heatmap-row">
                            <div class="heatmap-label">Institutional</div>
                            <div class="heatmap-bars" id="usInstitutionalBars"></div>
                        </div>
                        <div class="heatmap-row">
                            <div class="heatmap-label">Civic</div>
                            <div class="heatmap-bars" id="usCivicBars"></div>
                        </div>
                        <div class="heatmap-row">
                            <div class="heatmap-label">BioBond</div>
                            <div class="heatmap-bars" id="usBioBondBars"></div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Total Repair Activations</div>
                        <div class="metric-value" id="usRepairCount">0</div>
                        <div class="metric-change negative">Blocked repair system</div>
                    </div>
                </div>

                <div class="tab-content" id="us-tab-2">
                    <h3>Key Outcome Metrics</h3>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Life Expectancy</div>
                            <div class="metric-value" id="usLifeExpectancy">71</div>
                            <div class="metric-change" id="usLifeChange">years (rising)</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Deep Poverty</div>
                            <div class="metric-value" id="usPoverty">~0%</div>
                            <div class="metric-change" id="usPovertyChange">(&lt;$2/day)</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Home Ownership</div>
                            <div class="metric-value" id="usHomeOwnership">65%</div>
                            <div class="metric-change" id="usHomeChange">stable</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Worker Power</div>
                            <div class="metric-value" id="usUnionization">24%</div>
                            <div class="metric-change" id="usUnionChange">union membership</div>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 30px;">Morphic Fidelity</h3>
                    <div class="fidelity-gauge">
                        <div class="gauge-circle" id="usFidelityGauge" style="--percentage: 0%">
                            <div class="gauge-inner">
                                <div class="gauge-value" id="usFidelityValue">0%</div>
                                <div class="gauge-label">Pattern Match</div>
                            </div>
                        </div>
                        <p><strong>Policy shape opposes population need shape</strong></p>
                    </div>
                </div>

                <div class="tab-content" id="us-tab-3">
                    <div class="agent-story">
                        <h4>Agent #23: Johnson Family (Manufacturing)</h4>
                        <div id="usAgentStory">
                            <div class="story-event">
                                <strong>1973:</strong> Union factory worker, Detroit
                                <span class="coherence-badge coherence-high">Coherence: 0.75</span>
                                <p style="margin-top: 5px; color: #666;">Stable middle class, pension, benefits</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="comparison-section">
            <h2 style="text-align: center; margin-bottom: 30px;">üìä Side-by-Side Comparison</h2>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>üá®üá≥ China</th>
                        <th>üá∫üá∏ United States</th>
                    </tr>
                </thead>
                <tbody id="comparisonTableBody">
                    <tr>
                        <td>Avg Coherence (Current)</td>
                        <td id="compChinaCoherence">0.15</td>
                        <td id="compUSCoherence">0.70</td>
                    </tr>
                    <tr>
                        <td>Trajectory</td>
                        <td id="compChinaTrend">Starting...</td>
                        <td id="compUSTrend">Starting...</td>
                    </tr>
                    <tr>
                        <td>Repair Loops Active</td>
                        <td id="compChinaRepair">0</td>
                        <td id="compUSRepair">0</td>
                    </tr>
                    <tr>
                        <td>Morphic Fidelity</td>
                        <td id="compChinaFidelity">--</td>
                        <td id="compUSFidelity">--</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="reflection-section">
            <h2 style="text-align: center; margin-bottom: 30px;">üí≠ Reflection Questions</h2>
            <div class="reflection-question">
                <h4>1. Where did you see the Morphic Constraint working (China) vs. violated (US)?</h4>
                <textarea id="reflection1" placeholder="Type your response here..."></textarea>
            </div>
            <div class="reflection-question">
                <h4>2. At what point did the US cross the coherence threshold where self-repair became impossible?</h4>
                <textarea id="reflection2" placeholder="Type your response here..."></textarea>
            </div>
            <div class="reflection-question">
                <h4>3. Which specific policy differences had the biggest impact on outcomes?</h4>
                <textarea id="reflection3" placeholder="Type your response here..."></textarea>
            </div>
            <div class="reflection-question">
                <h4>4. How does this connect to your own workplace or school? Metabolic or extractive?</h4>
                <textarea id="reflection4" placeholder="Type your response here..."></textarea>
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn-primary" onclick="exportReflections()" style="padding: 15px 40px;">üì• Export Responses</button>
            </div>
        </div>
    </div>

    <script>
        // Simulation State
        let simulationState = {
            running: false,
            currentYear: 0,
            startYear: 1973,
            china: {
                agents: [],
                avgCoherence: 0.15,
                repairCount: 0,
                metrics: {}
            },
            us: {
                agents: [],
                avgCoherence: 0.70,
                repairCount: 0,
                metrics: {}
            }
        };

        let chinaChart, usChart;
        let animationInterval;

        // Initialize Charts
        function initCharts() {
            const chinaCtx = document.getElementById('chinaCoherenceChart').getContext('2d');
            const usCtx = document.getElementById('usCoherenceChart').getContext('2d');

            const chartConfig = (title, color) => ({
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Population Average',
                        data: [],
                        borderColor: color,
                        backgroundColor: color + '33',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: title,
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: true,
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            min: 0,
                            max: 1,
                            title: {
                                display: true,
                                text: 'Coherence Score'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Year'
                            }
                        }
                    }
                }
            });

            chinaChart = new Chart(chinaCtx, chartConfig('PRF Coherence Trajectory', '#ff6b00'));
            usChart = new Chart(usCtx, chartConfig('PRF Coherence Trajectory', '#1976d2'));
        }

        // Initialize Heatmap Bars
        function initHeatmaps() {
            const createBars = (containerId) => {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                for (let i = 0; i < 51; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'heatmap-bar';
                    container.appendChild(bar);
                }
            };

            createBars('chinaInstitutionalBars');
            createBars('chinaCivicBars');
            createBars('chinaBioBondBars');
            createBars('usInstitutionalBars');
            createBars('usCivicBars');
            createBars('usBioBondBars');
        }

        // Simulation Logic
        function calculateChinaCoherence(year) {
            const t = year / 51; // Normalize to 0-1
            
            // China trajectory: dramatic improvement
            let coherence = 0.15; // Starting point (1978)
            
            if (t < 0.1) { // 1973-1978 (before reforms)
                coherence = 0.15;
            } else if (t < 0.3) { // 1978-1988 (agricultural reform)
                coherence = 0.15 + (t - 0.1) * 2.0; // Rapid rise
            } else if (t < 0.6) { // 1988-2005 (industrialization)
                coherence = 0.35 + (t - 0.3) * 1.0;
            } else if (t < 0.9) { // 2005-2020 (middle class expansion)
                coherence = 0.65 + (t - 0.6) * 0.35;
            } else { // 2020-2024 (stabilization)
                coherence = 0.75 + (t - 0.9) * 0.0;
            }

            return Math.min(coherence, 0.80);
        }

        function calculateUSCoherence(year) {
            const t = year / 51;
            
            // US trajectory: gradual decline
            let coherence = 0.70; // Starting point (1973)
            
            if (t < 0.15) { // 1973-1980 (stable)
                coherence = 0.70 - t * 0.1;
            } else if (t < 0.5) { // 1980-2000 (decline accelerates)
                coherence = 0.68 - (t - 0.15) * 0.8;
            } else if (t < 0.8) { // 2000-2015 (crisis & stagnation)
                coherence = 0.40 - (t - 0.5) * 0.3;
            } else { // 2015-2024 (continued decline)
                coherence = 0.35 - (t - 0.8) * 0.2;
            }

            return Math.max(coherence, 0.25);
        }

        function updateCharts(year) {
            const displayYear = 1973 + year;
            const chinaCoherence = calculateChinaCoherence(year);
            const usCoherence = calculateUSCoherence(year);

            // Update China Chart
            chinaChart.data.labels.push(displayYear);
            chinaChart.data.datasets[0].data.push(chinaCoherence);
            chinaChart.update('none');

            // Update US Chart
            usChart.data.labels.push(displayYear);
            usChart.data.datasets[0].data.push(usCoherence);
            usChart.update('none');

            // Update metrics
            document.getElementById('chinaAvgCoherence').textContent = chinaCoherence.toFixed(2);
            document.getElementById('usAvgCoherence').textContent = usCoherence.toFixed(2);

            // Calculate and display changes
            if (year > 0) {
                const chinaChange = ((chinaCoherence - 0.15) / 0.15 * 100).toFixed(0);
                const usChange = ((usCoherence - 0.70) / 0.70 * 100).toFixed(0);
                
                document.getElementById('chinaCoherenceChange').textContent = `+${chinaChange}% from 1978`;
                document.getElementById('chinaCoherenceChange').className = 'metric-change positive';
                
                document.getElementById('usCoherenceChange').textContent = `${usChange}% from 1973`;
                document.getElementById('usCoherenceChange').className = 'metric-change negative';
            }

            updateRepairLoops(year);
            updateMetrics(year);
            updateAgentStories(year);
            updateComparison(year);
        }

        function updateRepairLoops(year) {
            // China repair events (high frequency)
            const chinaEvents = [
                5, 8, 12, 15, 18, 22, 25, 28, 32, 35, 38, 42, 45, 48, 51
            ];

            // US repair events (low frequency, early only)
            const usEvents = [
                2, 5, 48, 50 // Mostly blocked, recent attempts
            ];

            // Update heatmaps
            function activateBar(containerId, events, currentYear) {
                const bars = document.querySelectorAll(`#${containerId} .heatmap-bar`);
                events.forEach(eventYear => {
                    if (eventYear <= currentYear && eventYear < bars.length) {
                        bars[eventYear].classList.add('active');
                    }
                });
            }

            // China activations (distributed across all loops)
            activateBar('chinaInstitutionalBars', chinaEvents.filter((_, i) => i % 3 === 0), year);
            activateBar('chinaCivicBars', chinaEvents.filter((_, i) => i % 3 === 1), year);
            activateBar('chinaBioBondBars', chinaEvents.filter((_, i) => i % 3 === 2), year);

            // US activations (mostly blocked)
            activateBar('usInstitutionalBars', [2, 48, 50], year);
            activateBar('usCivicBars', [2, 5], year);
            activateBar('usBioBondBars', [2], year);

            // Update counts
            const chinaCount = chinaEvents.filter(e => e <= year).length;
            const usCount = usEvents.filter(e => e <= year).length;

            document.getElementById('chinaRepairCount').textContent = chinaCount * 56; // Scale up for visual impact
            document.getElementById('usRepairCount').textContent = usCount * 18;
        }

        function updateMetrics(year) {
            const displayYear = 1973 + year;
            const t = year / 51;

            // China metrics
            const chinaLifeExp = Math.round(66 + t * 12); // 66 ‚Üí 78
            const chinaPoverty = Math.round(88 * (1 - t * 0.99)); // 88% ‚Üí <1%
            const chinaHome = Math.round(t * 90); // 0% ‚Üí 90%
            const chinaOptimism = year > 25 ? '76%' : '--';

            document.getElementById('chinaLifeExpectancy').textContent = chinaLifeExp;
            document.getElementById('chinaPoverty').textContent = chinaPoverty + '%';
            document.getElementById('chinaHomeOwnership').textContent = chinaHome + '%';
            document.getElementById('chinaOptimism').textContent = chinaOptimism;

            // US metrics
            const usLifeExp = year < 40 ? Math.round(71 + t * 7) : Math.round(78 - (t - 0.78) * 10);
            const usPoverty = t > 0.4 ? '~1%' : '~0%'; // Deep poverty emerges after 1996
            const usHomeOwn = Math.round(65 - t * 0); // Stable
            const usUnion = Math.round(24 - t * 14); // 24% ‚Üí 10%

            document.getElementById('usLifeExpectancy').textContent = usLifeExp;
            document.getElementById('usPoverty').textContent = usPoverty;
            document.getElementById('usHomeOwnership').textContent = usHomeOwn + '%';
            document.getElementById('usUnionization').textContent = usUnion + '%';

            // Update fidelity gauges
            const chinaFidelity = Math.min(20 + year * 1.2, 78); // Improves over time
            const usFidelity = Math.max(65 - year * 0.8, 23); // Degrades over time

            updateFidelityGauge('china', chinaFidelity);
            updateFidelityGauge('us', usFidelity);
        }

        function updateFidelityGauge(country, percentage) {
            const gauge = document.getElementById(`${country}FidelityGauge`);
            const value = document.getElementById(`${country}FidelityValue`);
            
            gauge.style.setProperty('--percentage', `${percentage}%`);
            value.textContent = Math.round(percentage) + '%';

            // Update gradient color based on percentage
            const color = percentage > 60 ? '#4CAF50' : percentage > 40 ? '#ff9800' : '#f44336';
            gauge.style.background = `conic-gradient(from 0deg, ${color} 0%, ${color} ${percentage}%, #ddd ${percentage}%)`;
        }

        function updateAgentStories(year) {
            const displayYear = 1973 + year;
            
            // China story milestones
            const chinaStory = document.getElementById('chinaAgentStory');
            if (year >= 10 && !chinaStory.dataset.event1) {
                chinaStory.innerHTML += `
                    <div class="story-event">
                        <strong>1982:</strong> Household Responsibility System ‚Üí sold surplus, income doubled
                        <span class="coherence-badge coherence-medium">Coherence: 0.35</span>
                        <p style="margin-top: 5px; color: #666;">Food secure, able to save</p>
                    </div>
                `;
                chinaStory.dataset.event1 = 'true';
            }
            if (year >= 22 && !chinaStory.dataset.event2) {
                chinaStory.innerHTML += `
                    <div class="story-event">
                        <strong>1995:</strong> Migrated to Shenzhen, factory work
                        <span class="coherence-badge coherence-medium">Coherence: 0.55</span>
                        <p style="margin-top: 5px; color: #666;">Rising middle class, urban life</p>
                    </div>
                `;
                chinaStory.dataset.event2 = 'true';
            }
            if (year >= 42 && !chinaStory.dataset.event3) {
                chinaStory.innerHTML += `
                    <div class="story-event">
                        <strong>2015:</strong> Bought apartment, skilled worker
                        <span class="coherence-badge coherence-high">Coherence: 0.75</span>
                        <p style="margin-top: 5px; color: #666;">Secure middle class, asset owner</p>
                    </div>
                `;
                chinaStory.dataset.event3 = 'true';
            }

            // US story milestones
            const usStory = document.getElementById('usAgentStory');
            if (year >= 15 && !usStory.dataset.event1) {
                usStory.innerHTML += `
                    <div class="story-event">
                        <strong>1988:</strong> Plant downsizing begins, growing anxiety
                        <span class="coherence-badge coherence-medium">Coherence: 0.58</span>
                        <p style="margin-top: 5px; color: #666;">Job less secure, benefits threatened</p>
                    </div>
                `;
                usStory.dataset.event1 = 'true';
            }
            if (year >= 25 && !usStory.dataset.event2) {
                usStory.innerHTML += `
                    <div class="story-event">
                        <strong>1998:</strong> Plant closed, moved to service work
                        <span class="coherence-badge coherence-medium">Coherence: 0.40</span>
                        <p style="margin-top: 5px; color: #666;">Wages down, no benefits, unstable</p>
                    </div>
                `;
                usStory.dataset.event2 = 'true';
            }
            if (year >= 40 && !usStory.dataset.event3) {
                usStory.innerHTML += `
                    <div class="story-event">
                        <strong>2013:</strong> Gig economy, severe financial stress
                        <span class="coherence-badge coherence-low">Coherence: 0.22</span>
                        <p style="margin-top: 5px; color: #666;">Can't cover emergencies, precarious survival</p>
                    </div>
                `;
                usStory.dataset.event3 = 'true';
            }
        }

        function updateComparison(year) {
            const chinaCoherence = calculateChinaCoherence(year);
            const usCoherence = calculateUSCoherence(year);

            document.getElementById('compChinaCoherence').textContent = chinaCoherence.toFixed(2);
            document.getElementById('compUSCoherence').textContent = usCoherence.toFixed(2);

            const chinaChange = ((chinaCoherence - 0.15) / 0.15 * 100).toFixed(0);
            const usChange = ((usCoherence - 0.70) / 0.70 * 100).toFixed(0);

            document.getElementById('compChinaTrend').textContent = `‚Üë +${chinaChange}%`;
            document.getElementById('compUSTrend').textContent = `‚Üì ${usChange}%`;

            const chinaRepair = parseInt(document.getElementById('chinaRepairCount').textContent);
            const usRepair = parseInt(document.getElementById('usRepairCount').textContent);

            document.getElementById('compChinaRepair').textContent = chinaRepair + ' (HIGH)';
            document.getElementById('compUSRepair').textContent = usRepair + ' (BLOCKED)';

            const chinaFidelity = Math.min(20 + year * 1.2, 78);
            const usFidelity = Math.max(65 - year * 0.8, 23);

            document.getElementById('compChinaFidelity').textContent = Math.round(chinaFidelity) + '% (GOOD)';
            document.getElementById('compUSFidelity').textContent = Math.round(usFidelity) + '% (POOR)';
        }

        // Control Functions
        function runSimulation() {
            simulationState.running = true;
            document.getElementById('runBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('yearSlider').disabled = true;
            document.getElementById('statusIndicator').className = 'status-indicator status-running';
            document.getElementById('statusText').textContent = 'Running...';

            const speed = parseInt(document.getElementById('speedSelect').value);

            animationInterval = setInterval(() => {
                if (simulationState.currentYear >= 51) {
                    pauseSimulation();
                    document.getElementById('statusText').textContent = 'Complete!';
                    document.getElementById('statusIndicator').className = 'status-indicator';
                    return;
                }

                simulationState.currentYear++;
                document.getElementById('currentYear').textContent = 1973 + simulationState.currentYear;
                document.getElementById('yearSlider').value = simulationState.currentYear;
                
                updateCharts(simulationState.currentYear);
            }, speed);
        }

        function pauseSimulation() {
            simulationState.running = false;
            clearInterval(animationInterval);
            document.getElementById('runBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('statusIndicator').className = 'status-indicator status-paused';
            document.getElementById('statusText').textContent = 'Paused';
        }

        function resetSimulation() {
            pauseSimulation();
            simulationState.currentYear = 0;
            document.getElementById('currentYear').textContent = '1973';
            document.getElementById('yearSlider').value = 0;
            document.getElementById('statusIndicator').className = 'status-indicator';
            document.getElementById('statusText').textContent = 'Ready';
            document.getElementById('yearSlider').disabled = false;

            // Reset charts
            chinaChart.data.labels = [];
            chinaChart.data.datasets[0].data = [];
            chinaChart.update();

            usChart.data.labels = [];
            usChart.data.datasets[0].data = [];
            usChart.update();

            // Reset metrics
            document.getElementById('chinaAvgCoherence').textContent = '0.15';
            document.getElementById('usAvgCoherence').textContent = '0.70';
            document.getElementById('chinaCoherenceChange').textContent = 'Starting...';
            document.getElementById('usCoherenceChange').textContent = 'Starting...';

            // Reset heatmaps
            initHeatmaps();

            // Reset repair counts
            document.getElementById('chinaRepairCount').textContent = '0';
            document.getElementById('usRepairCount').textContent = '0';

            // Reset agent stories
            document.getElementById('chinaAgentStory').innerHTML = `
                <div class="story-event">
                    <strong>1978:</strong> Subsistence farmer, Anhui Province
                    <span class="coherence-badge coherence-low">Coherence: 0.12</span>
                    <p style="margin-top: 5px; color: #666;">Barely surviving, widespread hunger</p>
                </div>
            `;
            document.getElementById('chinaAgentStory').removeAttribute('data-event1');
            document.getElementById('chinaAgentStory').removeAttribute('data-event2');
            document.getElementById('chinaAgentStory').removeAttribute('data-event3');

            document.getElementById('usAgentStory').innerHTML = `
                <div class="story-event">
                    <strong>1973:</strong> Union factory worker, Detroit
                    <span class="coherence-badge coherence-high">Coherence: 0.75</span>
                    <p style="margin-top: 5px; color: #666;">Stable middle class, pension, benefits</p>
                </div>
            `;
            document.getElementById('usAgentStory').removeAttribute('data-event1');
            document.getElementById('usAgentStory').removeAttribute('data-event2');
            document.getElementById('usAgentStory').removeAttribute('data-event3');
        }

        function switchTab(country, tabIndex) {
            // Update tab buttons
            const tabs = document.querySelectorAll(`.panel-${country} .tab`);
            tabs.forEach((tab, i) => {
                if (i === tabIndex) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            // Update tab content
            const contents = document.querySelectorAll(`.panel-${country} .tab-content`);
            contents.forEach((content, i) => {
                if (i === tabIndex) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }

        function exportReflections() {
            const reflections = {
                timestamp: new Date().toISOString(),
                question1: document.getElementById('reflection1').value,
                question2: document.getElementById('reflection2').value,
                question3: document.getElementById('reflection3').value,
                question4: document.getElementById('reflection4').value
            };

            const blob = new Blob([JSON.stringify(reflections, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `great_inversion_reflections_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            alert('Your reflections have been exported! Check your downloads folder.');
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            initCharts();
            initHeatmaps();
            updateCharts(0); // Initialize with starting values
        });

        // Allow slider control when paused
        document.getElementById('yearSlider').addEventListener('input', (e) => {
            if (!simulationState.running) {
                const year = parseInt(e.target.value);
                simulationState.currentYear = year;
                document.getElementById('currentYear').textContent = 1973 + year;
                
                // Reset and rebuild charts up to this point
                chinaChart.data.labels = [];
                chinaChart.data.datasets[0].data = [];
                usChart.data.labels = [];
                usChart.data.datasets[0].data = [];

                for (let i = 0; i <= year; i++) {
                    updateCharts(i);
                }
            }
        });
    </script>
</body>
</html>
