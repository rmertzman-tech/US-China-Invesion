<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Great Inversion Simulator - Ethics Beyond Boundaries</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .header-buttons {
            position: absolute;
            top: 30px;
            right: 30px;
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .icon-btn:hover {
            background: white;
            color: #1e3c72;
            transform: scale(1.1);
        }

        .controls {
            background: #f8f9fa;
            padding: 25px;
            border-bottom: 3px solid #dee2e6;
        }

        .control-row {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        .btn-secondary {
            background: #2196F3;
            color: white;
        }

        .btn-secondary:hover {
            background: #0b7dda;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #da190b;
        }

        .split-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 600px;
        }

        .panel {
            padding: 30px;
            overflow-y: auto;
        }

        .panel-china {
            background: #fff3e0;
            border-right: 3px solid #ff9800;
        }

        .panel-us {
            background: #e3f2fd;
        }

        .panel h2 {
            font-size: 2em;
            margin-bottom: 20px;
            text-align: center;
        }

        .panel-china h2 {
            color: #e65100;
        }

        .panel-us h2 {
            color: #0d47a1;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #333;
            background: rgba(0,0,0,0.05);
        }

        .tab.active {
            color: #2196F3;
            border-bottom-color: #2196F3;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .explanation-box {
            background: #e8f5e9;
            border-left: 4px solid #4CAF50;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
        }

        .explanation-box h4 {
            color: #2e7d32;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .explanation-box p {
            color: #1b5e20;
            line-height: 1.6;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 20px 0;
        }

        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }

        .metric-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-change {
            font-size: 14px;
            font-weight: 600;
        }

        .metric-change.positive {
            color: #4CAF50;
        }

        .metric-change.negative {
            color: #f44336;
        }

        .tooltip-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            background: #2196F3;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 18px;
            font-size: 12px;
            cursor: help;
            margin-left: 5px;
            position: relative;
        }

        .tooltip-icon:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            white-space: nowrap;
            font-size: 12px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .tooltip-icon:hover::before {
            content: '';
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #333;
            z-index: 1000;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            overflow-y: auto;
            animation: modalFadeIn 0.3s;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 40px;
            width: 90%;
            max-width: 800px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideUp 0.3s;
        }

        @keyframes modalSlideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #2196F3;
        }

        .modal-header h2 {
            color: #2196F3;
            font-size: 2em;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 36px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            line-height: 1;
        }

        .close-btn:hover {
            color: #333;
        }

        .glossary-term {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #2196F3;
        }

        .glossary-term h3 {
            color: #2196F3;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .glossary-term p {
            color: #333;
            line-height: 1.6;
        }

        .glossary-term .example {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            font-style: italic;
            color: #666;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .comparison-section {
            padding: 30px;
            background: #f5f5f5;
        }

        .comparison-table {
            width: 100%;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .comparison-table th,
        .comparison-table td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }

        .comparison-table th {
            background: #2196F3;
            color: white;
            font-weight: 600;
        }

        .comparison-table td:first-child {
            text-align: left;
            font-weight: 600;
        }

        .timeline {
            margin: 30px 0;
            padding: 20px;
            background: white;
            border-radius: 12px;
        }

        .timeline-slider {
            width: 100%;
            margin: 20px 0;
        }

        .agent-story {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 4px solid #2196F3;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .agent-story h4 {
            color: #2196F3;
            margin-bottom: 15px;
        }

        .story-event {
            padding: 10px;
            margin: 10px 0;
            border-left: 3px solid #ddd;
            padding-left: 15px;
        }

        .coherence-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 10px;
        }

        .coherence-high {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .coherence-medium {
            background: #fff9c4;
            color: #f57f17;
        }

        .coherence-low {
            background: #ffcdd2;
            color: #c62828;
        }

        .reflection-section {
            padding: 30px;
            background: #e8f5e9;
        }

        .reflection-question {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .reflection-question h4 {
            color: #2e7d32;
            margin-bottom: 10px;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
        }

        textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .info-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .info-box strong {
            color: #f57f17;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-running {
            background: #4CAF50;
            animation: pulse 1.5s infinite;
        }

        .status-paused {
            background: #ff9800;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .heatmap {
            display: grid;
            grid-template-rows: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .heatmap-row {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 10px;
            align-items: center;
        }

        .heatmap-label {
            font-weight: 600;
            color: #333;
        }

        .heatmap-bars {
            display: flex;
            gap: 2px;
            height: 30px;
        }

        .heatmap-bar {
            flex: 1;
            background: #ddd;
            transition: background 0.3s;
        }

        .heatmap-bar.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .debt-tracker {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .fidelity-gauge {
            text-align: center;
            padding: 30px;
        }

        .gauge-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: bold;
            color: white;
            position: relative;
            background: conic-gradient(from 0deg, #4CAF50 0%, #4CAF50 var(--percentage), #ddd var(--percentage));
        }

        .gauge-inner {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .gauge-value {
            font-size: 48px;
            font-weight: bold;
            color: #333;
        }

        .gauge-label {
            font-size: 14px;
            color: #666;
        }

        .tutorial-section {
            padding: 30px;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }

        .tutorial-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .tutorial-step {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-top: 4px solid #2196F3;
        }

        .tutorial-step h3 {
            color: #2196F3;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-number {
            background: #2196F3;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .faculty-guide {
            background: #fff;
            padding: 30px;
            border-top: 3px solid #9c27b0;
        }

        .faculty-section {
            margin: 25px 0;
            padding: 20px;
            background: #f3e5f5;
            border-radius: 12px;
        }

        .faculty-section h3 {
            color: #9c27b0;
            margin-bottom: 15px;
        }

        .key-term {
            background: #e1f5fe;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
            color: #0277bd;
            cursor: pointer;
        }

        .key-term:hover {
            background: #b3e5fc;
            text-decoration: underline;
        }

        @media (max-width: 1200px) {
            .split-view {
                grid-template-columns: 1fr;
            }
            
            .panel-china {
                border-right: none;
                border-bottom: 3px solid #ff9800;
            }

            .header-buttons {
                position: static;
                justify-content: center;
                margin-top: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-buttons">
                <button class="icon-btn" onclick="openModal('intro')" title="Getting Started">‚ÑπÔ∏è</button>
                <button class="icon-btn" onclick="openModal('glossary')" title="Glossary">üìñ</button>
                <button class="icon-btn" onclick="openModal('faculty')" title="Faculty Guide">üë©‚Äçüè´</button>
            </div>
            <h1>üåê The Great Inversion Simulator</h1>
            <p>Metabolic vs. Extractive Capitalism: China & United States (1973-2024)</p>
        </div>

        <!-- INTRODUCTION MODAL -->
        <div id="introModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üìö Getting Started</h2>
                    <button class="close-btn" onclick="closeModal('intro')">&times;</button>
                </div>
                
                <div class="tutorial-section">
                    <h3 style="text-align: center; margin-bottom: 20px;">Welcome to The Great Inversion Simulator!</h3>
                    <p style="text-align: center; font-size: 1.1em; margin-bottom: 30px;">
                        This interactive tool helps you understand why the same economic system (capitalism) produced 
                        dramatically different outcomes in China and the United States over the past 50 years.
                    </p>

                    <div class="tutorial-steps">
                        <div class="tutorial-step">
                            <h3><span class="step-number">1</span> Watch</h3>
                            <p>Click "‚ñ∂ Run Simulation" to watch 51 years unfold. See how two nations with similar 
                            starting resources diverge completely.</p>
                        </div>
                        <div class="tutorial-step">
                            <h3><span class="step-number">2</span> Explore</h3>
                            <p>Click the tabs (Coherence, Repair Loops, Metrics, Agent Story) to see different views 
                            of what's happening in each country.</p>
                        </div>
                        <div class="tutorial-step">
                            <h3><span class="step-number">3</span> Compare</h3>
                            <p>Scroll down to see side-by-side comparisons. Notice how the same mechanisms produce 
                            opposite outcomes based on institutional design.</p>
                        </div>
                        <div class="tutorial-step">
                            <h3><span class="step-number">4</span> Reflect</h3>
                            <p>Answer the reflection questions at the bottom. These help you connect what you're 
                            seeing to your own life and institutions.</p>
                        </div>
                    </div>

                    <div class="explanation-box" style="margin-top: 30px;">
                        <h4>üí° What You'll Learn</h4>
                        <p><strong>Main Question:</strong> Why did China lift 800 million people out of poverty while 
                        the US saw its working class decline‚Äîusing the same economic system?</p>
                        <p style="margin-top: 10px;"><strong>Main Answer:</strong> Institutional design matters more than 
                        economic labels. China used capitalism "metabolically" (supporting human flourishing), while the 
                        US used it "extractively" (damaging working-class security).</p>
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn-primary" onclick="closeModal('intro')" style="padding: 15px 40px;">
                            Got it! Let's begin ‚Üí
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- GLOSSARY MODAL -->
        <div id="glossaryModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üìñ Key Terms Glossary</h2>
                    <button class="close-btn" onclick="closeModal('glossary')">&times;</button>
                </div>

                <div class="glossary-term">
                    <h3>PRF (Phenomenological Reference Framework)</h3>
                    <p><strong>Simple definition:</strong> Your internal sense of who you are, how the world works, and your place in it.</p>
                    <p><strong>In this simulation:</strong> We measure PRF as "coherence"‚Äîwhether someone can maintain their identity, 
                    handle current stress, see a future path, and help others. High coherence = secure and integrated. Low coherence = 
                    fragmented and overwhelmed.</p>
                    <div class="example">Example: A factory worker with steady employment, union protection, and retirement benefits has 
                    high PRF coherence. The same worker laid off, in debt, with no prospects has low coherence.</div>
                </div>

                <div class="glossary-term">
                    <h3>ITA (Institutional Template Agreement)</h3>
                    <p><strong>Simple definition:</strong> The rules, policies, and structures that shape how an institution works.</p>
                    <p><strong>In this simulation:</strong> China's ITA (state-directed capitalism) vs. US ITA (financialized capitalism). 
                    Same tools (markets, prices, private ownership), different rules about who benefits.</p>
                    <div class="example">Example: Both countries have stock markets, but China restricts how companies can use profits 
                    (must invest in growth), while US allows stock buybacks (profits to shareholders instead of workers).</div>
                </div>

                <div class="glossary-term">
                    <h3>Metabolic Institution</h3>
                    <p><strong>Simple definition:</strong> An institution that supports people's ability to recover from stress and maintain 
                    their sense of self.</p>
                    <p><strong>In this simulation:</strong> China's approach‚Äîusing markets to lift people out of poverty, investing in 
                    infrastructure that reduces costs and increases opportunity, monitoring population well-being and adjusting policy.</p>
                    <div class="example">Example: China built 45,000 km of high-speed rail, making it easier for people to find work, 
                    visit family, and access opportunities. This supports coherence by reducing isolation.</div>
                </div>

                <div class="glossary-term">
                    <h3>Extractive Institution</h3>
                    <p><strong>Simple definition:</strong> An institution that takes more from people than it gives back, gradually 
                    damaging their capacity to function.</p>
                    <p><strong>In this simulation:</strong> US approach‚Äîallowing profits to flow to shareholders instead of workers, 
                    commodifying healthcare and housing, removing safety nets while precarity increases.</p>
                    <div class="example">Example: US productivity increased 150% since 1973, but real wages only increased 15%. The 
                    difference was extracted by shareholders through mechanisms like stock buybacks.</div>
                </div>

                <div class="glossary-term">
                    <h3>Coherence</h3>
                    <p><strong>Simple definition:</strong> Your ability to hold yourself together‚Äîpast, present, and future‚Äîunder pressure.</p>
                    <p><strong>In this simulation:</strong> Measured on a 0-1 scale. Tracks four dimensions: connection to your history, 
                    ability to function now, seeing a path forward, and capacity to help others.</p>
                    <div class="example">Example: Someone with 0.75 coherence can handle setbacks, knows who they are, sees possibilities 
                    ahead. Someone with 0.20 is overwhelmed, fragmented, stuck in survival mode.</div>
                </div>

                <div class="glossary-term">
                    <h3>Repair Loops</h3>
                    <p><strong>Simple definition:</strong> The ways systems respond when people are stressed or damaged.</p>
                    <p><strong>Three levels:</strong></p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li><strong>BioBond (Individual):</strong> Personal and community support‚Äîfamily, friends, local help</li>
                        <li><strong>Civic (Organizational):</strong> Local institutions adapting‚Äîunions, community groups, local government</li>
                        <li><strong>Institutional (National):</strong> Policy changes‚Äîlaws, regulations, national programs</li>
                    </ul>
                    <div class="example">Example: You lose your job. BioBond = friends help. Civic = local job training program. 
                    Institutional = unemployment benefits and job creation policy. If all three work, you recover. If blocked, you fragment.</div>
                </div>

                <div class="glossary-term">
                    <h3>Morphic Constraint / Morphic Fidelity</h3>
                    <p><strong>Simple definition:</strong> The degree to which policy responses match the shape of population needs.</p>
                    <p><strong>In this simulation:</strong> High fidelity = when people experience stress, policy provides matching support. 
                    Low fidelity = policy ignores or worsens stress. Measured as percentage (0-100%).</p>
                    <div class="example">Example: Rural poverty in China ‚Üí State invests in rural infrastructure. That's high morphic 
                    fidelity (policy matches need). US workers need higher wages ‚Üí Corporate tax cuts for shareholders. That's low fidelity 
                    (policy opposite to need).</div>
                </div>

                <div class="glossary-term">
                    <h3>Coherence Threshold</h3>
                    <p><strong>Simple definition:</strong> The point below which someone can't recover on their own‚Äîthey need external help.</p>
                    <p><strong>In this simulation:</strong> Like a battery that's too drained to recharge itself. Below threshold, repair 
                    loops must activate or the person stays fragmented.</p>
                    <div class="example">Example: Someone with coherence above 0.35 can usually bounce back from setbacks with minimal 
                    support. Below 0.35, they need significant institutional intervention to recover.</div>
                </div>

                <div class="glossary-term">
                    <h3>Moral Debt</h3>
                    <p><strong>Simple definition:</strong> Accumulated unaddressed damage to people's well-being.</p>
                    <p><strong>In this simulation:</strong> When institutions damage people and don't repair it, debt accumulates. If 
                    ignored, it compounds‚Äîcreating cascading crises like the opioid epidemic.</p>
                    <div class="example">Example: US removed welfare safety net (1996) precisely when job precarity was rising. This 
                    created moral debt. That debt later manifested as homelessness, "deaths of despair," and community breakdown.</div>
                </div>
            </div>
        </div>

        <!-- FACULTY GUIDE MODAL -->
        <div id="facultyModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üë©‚Äçüè´ Faculty Guide</h2>
                    <button class="close-btn" onclick="closeModal('faculty')">&times;</button>
                </div>

                <div class="faculty-guide">
                    <h3 style="text-align: center; margin-bottom: 30px;">How to Use This Simulator in Your Course</h3>

                    <div class="faculty-section">
                        <h3>üìã Learning Objectives</h3>
                        <p>By completing this simulation, students will be able to:</p>
                        <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
                            <li>Explain why the same economic mechanisms can produce opposite outcomes based on institutional design</li>
                            <li>Distinguish between metabolic (supportive) and extractive (damaging) institutional structures</li>
                            <li>Analyze how repair loops function or get blocked at individual, civic, and institutional levels</li>
                            <li>Evaluate morphic fidelity between policy responses and population needs</li>
                            <li>Apply these concepts to their own institutional contexts (workplace, school, community)</li>
                        </ul>
                    </div>

                    <div class="faculty-section">
                        <h3>‚è±Ô∏è Suggested Timing</h3>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li><strong>In-class demonstration:</strong> 20-30 minutes (run simulation together, discuss as it unfolds)</li>
                            <li><strong>Student homework:</strong> 30-45 minutes (explore independently, complete reflection questions)</li>
                            <li><strong>Class discussion:</strong> 30-40 minutes (debrief findings, connect to course concepts)</li>
                        </ul>
                    </div>

                    <div class="faculty-section">
                        <h3>üéØ Pre-Simulation Setup</h3>
                        <p><strong>Before students use the simulator, cover these foundational concepts:</strong></p>
                        <ol style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
                            <li><strong>Basic economic systems:</strong> Capitalism, socialism, mixed economies (10 min lecture or reading)</li>
                            <li><strong>Institutional design matters:</strong> Rules and structures shape outcomes (use simple example: 
                            classroom with/without rules produces different learning)</li>
                            <li><strong>Individual vs. systemic level:</strong> What's true for one person isn't always true for the system 
                            (e.g., one person saving is good, everyone hoarding is recession)</li>
                        </ol>
                        <p style="margin-top: 10px;"><strong>Assign pre-reading:</strong> The "Great Inversion" case study text 
                        (~3,500 words, provided separately) or a summary excerpt.</p>
                    </div>

                    <div class="faculty-section">
                        <h3>üìä What Each Visualization Shows</h3>
                        <p><strong>Coherence Charts (Tab 1):</strong> Population-level well-being over time. China's line goes up 
                        (poverty ‚Üí middle class), US line goes down (middle class ‚Üí precarity). This is the core finding.</p>
                        
                        <p style="margin-top: 15px;"><strong>Repair Loops Heatmap (Tab 2):</strong> Shows when systems respond to 
                        stress. China: frequent activations (active repair). US: sparse, blocked after 1980s. Students see WHY 
                        trajectories differ‚ÄîChina fixes problems, US doesn't.</p>
                        
                        <p style="margin-top: 15px;"><strong>Metrics (Tab 3):</strong> Concrete outcomes (life expectancy, poverty, 
                        homeownership). Makes abstract "coherence" tangible. Morphic fidelity gauge shows policy-need alignment.</p>
                        
                        <p style="margin-top: 15px;"><strong>Agent Stories (Tab 4):</strong> Personal narratives. Wang Li goes from 
                        subsistence farmer to middle-class homeowner. Johnson family goes from union factory worker to gig economy 
                        precarity. Humanizes the data.</p>
                    </div>

                    <div class="faculty-section">
                        <h3>üí¨ Discussion Prompts</h3>
                        <p><strong>During simulation:</strong></p>
                        <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
                            <li>"Pause at 1982 (year 9). What just happened in China? Why did coherence jump?" (Agricultural reform)</li>
                            <li>"Pause at 1998 (year 25). Look at US repair loops. What's missing?" (Civic loops blocked)</li>
                            <li>"Look at morphic fidelity scores. What does 78% vs 23% mean practically?" (Policy matches needs vs. opposes them)</li>
                        </ul>

                        <p style="margin-top: 15px;"><strong>After simulation:</strong></p>
                        <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
                            <li>"Which specific policy differences had biggest impact? Why?"</li>
                            <li>"Can you think of an institution you're part of? Metabolic or extractive? Give evidence."</li>
                            <li>"Is China's model sustainable? What about its limitations?" (Authoritarian control, Hukou system, 
                            environmental damage, "involution" pressure)</li>
                            <li>"Can the US reverse its trajectory? What would it take?" (Reactivate repair loops, discipline capital, 
                            address moral debt)</li>
                        </ul>
                    </div>

                    <div class="faculty-section">
                        <h3>‚úèÔ∏è Assessment Options</h3>
                        <p><strong>Low-stakes (participation):</strong></p>
                        <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.6;">
                            <li>Complete reflection questions (in-app or on separate document)</li>
                            <li>One-page response: "What surprised you most?"</li>
                        </ul>

                        <p style="margin-top: 15px;"><strong>Medium-stakes (homework/quiz):</strong></p>
                        <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.6;">
                            <li>Define 5 key terms from glossary in your own words with examples</li>
                            <li>Analyze your workplace or school using metabolic/extractive framework (2-3 pages)</li>
                        </ul>

                        <p style="margin-top: 15px;"><strong>High-stakes (essay/project):</strong></p>
                        <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.6;">
                            <li>Compare another country pair using the same framework (India/Brazil, Japan/US, etc.)</li>
                            <li>Propose policy changes to make a US institution more metabolic (with evidence from simulation)</li>
                            <li>Debate: "Is China's authoritarian capitalism preferable to US democratic capitalism?"</li>
                        </ul>
                    </div>

                    <div class="faculty-section">
                        <h3>‚ö†Ô∏è Common Student Misconceptions</h3>
                        <p><strong>Misconception 1:</strong> "This proves socialism is better than capitalism."</p>
                        <p style="margin-left: 20px; color: #666;"><strong>Clarification:</strong> Both countries use capitalism (markets, 
                        private ownership). The difference is institutional design‚Äîhow capitalism is structured and constrained, not 
                        whether it exists.</p>

                        <p style="margin-top: 15px;"><strong>Misconception 2:</strong> "China's success is just because of cheap labor."</p>
                        <p style="margin-left: 20px; color: #666;"><strong>Clarification:</strong> Labor costs explain why manufacturing 
                        moved to China, not why Chinese citizens' well-being improved. The key is how gains were distributed‚Äîinvested in 
                        infrastructure and poverty reduction, not just extracted by elites.</p>

                        <p style="margin-top: 15px;"><strong>Misconception 3:</strong> "The US just needs to copy China."</p>
                        <p style="margin-left: 20px; color: #666;"><strong>Clarification:</strong> China's authoritarian model constrains 
                        political freedom (low agency in one PRF dimension). The lesson isn't "copy China" but "design institutions that 
                        preserve coherence"‚Äîwhich democracies can do while maintaining freedoms.</p>

                        <p style="margin-top: 15px;"><strong>Misconception 4:</strong> "Individual choices don't matter, only systems."</p>
                        <p style="margin-left: 20px; color: #666;"><strong>Clarification:</strong> Both matter. Individuals make choices 
                        within institutional constraints. Good institutions expand choices; bad institutions constrain them. Wang Li chose 
                        to migrate and work hard, but China's infrastructure made that choice viable.</p>
                    </div>

                    <div class="faculty-section">
                        <h3>üîó Connections to Other Topics</h3>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li><strong>Business ethics:</strong> Corporate responsibility vs. shareholder primacy (extractive logic)</li>
                            <li><strong>Environmental ethics:</strong> Tragedy of the commons vs. collective action (repair loops)</li>
                            <li><strong>Social justice:</strong> Structural inequality vs. individual responsibility (systemic analysis)</li>
                            <li><strong>Healthcare ethics:</strong> Commodification of care vs. right to health (metabolic institutions)</li>
                            <li><strong>Technology ethics:</strong> Platform capitalism (extractive) vs. cooperative platforms (metabolic)</li>
                        </ul>
                    </div>

                    <div class="faculty-section">
                        <h3>üõ†Ô∏è Technical Notes</h3>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li><strong>Works on all devices:</strong> Desktop, tablet, mobile (responsive design)</li>
                            <li><strong>No installation required:</strong> Runs in any modern web browser</li>
                            <li><strong>No student data collected:</strong> Completely private, client-side only</li>
                            <li><strong>Reflection export:</strong> Students can download their responses as JSON file</li>
                            <li><strong>Accessibility:</strong> Screen reader compatible, keyboard navigable</li>
                        </ul>
                    </div>

                    <div style="text-align: center; margin-top: 30px; padding: 20px; background: #e1f5fe; border-radius: 12px;">
                        <p style="font-size: 1.1em;"><strong>Questions or feedback?</strong></p>
                        <p style="margin-top: 10px;">This tool is part of the <em>Ethics Beyond Boundaries</em> curriculum. 
                        For additional teaching materials, case studies, or to share your implementation experiences, please contact 
                        the course developers.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <span class="status-indicator" id="statusIndicator"></span>
                    <strong>Status:</strong>
                    <span id="statusText">Ready</span>
                </div>
                <div class="control-group">
                    <button class="btn-primary" id="runBtn" onclick="runSimulation()">‚ñ∂ Run Simulation</button>
                    <button class="btn-secondary" id="pauseBtn" onclick="pauseSimulation()" disabled>‚è∏ Pause</button>
                    <button class="btn-danger" onclick="resetSimulation()">‚Üª Reset</button>
                </div>
            </div>
            <div class="control-row">
                <div class="control-group">
                    <label><strong>Time Period:</strong></label>
                    <input type="range" id="yearSlider" class="timeline-slider" min="0" max="51" value="0" disabled>
                    <span id="currentYear">1973</span>
                </div>
                <div class="control-group">
                    <label><strong>Speed:</strong></label>
                    <select id="speedSelect">
                        <option value="1000">1x</option>
                        <option value="500" selected>2x</option>
                        <option value="200">5x</option>
                        <option value="100">10x</option>
                    </select>
                </div>
            </div>
            <div class="info-box">
                <strong>üí° What you're about to see:</strong> Watch as identical starting populations experience opposite trajectories 
                based on institutional design. China uses capitalism <span class="key-term" onclick="openGlossaryTerm('metabolic')">metabolically</span> 
                (supporting <span class="key-term" onclick="openGlossaryTerm('coherence')">coherence</span>), while the US uses it 
                <span class="key-term" onclick="openGlossaryTerm('extractive')">extractively</span> (damaging coherence). The 
                <span class="key-term" onclick="openGlossaryTerm('morphic')">Morphic Constraint</span> principle shows why the same 
                mechanisms produce different outcomes. Click any <span class="key-term">blue term</span> to see its definition.
            </div>
        </div>

        <div class="split-view">
            <!-- CHINA PANEL -->
            <div class="panel panel-china">
                <h2>üá®üá≥ China: Metabolic Capitalism</h2>
                
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('china', 0)">Coherence</button>
                    <button class="tab" onclick="switchTab('china', 1)">Repair Loops</button>
                    <button class="tab" onclick="switchTab('china', 2)">Metrics</button>
                    <button class="tab" onclick="switchTab('china', 3)">Agent Story</button>
                </div>

                <div class="tab-content active" id="china-tab-0">
                    <div class="explanation-box">
                        <h4>üìä What This Chart Shows</h4>
                        <p>This line graph tracks population-level <strong>coherence</strong> (well-being) over time. 
                        Watch how China's average coherence rises dramatically from 0.15 (survival mode) to 0.75 (secure middle class). 
                        This represents 800+ million people moving out of poverty.</p>
                    </div>
                    <div class="chart-container">
                        <canvas id="chinaCoherenceChart"></canvas>
                    </div>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">
                                Average Coherence
                                <span class="tooltip-icon" data-tooltip="0-1 scale: Higher = more secure & integrated">?</span>
                            </div>
                            <div class="metric-value" id="chinaAvgCoherence">0.15</div>
                            <div class="metric-change" id="chinaCoherenceChange">Starting...</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">
                                Population Below Threshold
                                <span class="tooltip-icon" data-tooltip="Threshold = point where self-repair impossible">?</span>
                            </div>
                            <div class="metric-value" id="chinaBelowThreshold">88%</div>
                            <div class="metric-change" id="chinaThresholdChange">Initial state</div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="china-tab-1">
                    <div class="explanation-box">
                        <h4>üîÑ What This Heatmap Shows</h4>
                        <p>Each colored bar represents a <strong>repair loop activation</strong>‚Äîwhen the system responded to population 
                        stress. <strong>Institutional</strong> = national policy changes. <strong>Civic</strong> = community/organizational 
                        adaptations. <strong>BioBond</strong> = individual/family support. More colored bars = more active repair system.</p>
                    </div>
                    <h3>Repair Loop Activations</h3>
                    <div class="heatmap">
                        <div class="heatmap-row">
                            <div class="heatmap-label">Institutional</div>
                            <div class="heatmap-bars" id="chinaInstitutionalBars"></div>
                        </div>
                        <div class="heatmap-row">
                            <div class="heatmap-label">Civic</div>
                            <div class="heatmap-bars" id="chinaCivicBars"></div>
                        </div>
                        <div class="heatmap-row">
                            <div class="heatmap-label">BioBond</div>
                            <div class="heatmap-bars" id="chinaBioBondBars"></div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Total Repair Activations</div>
                        <div class="metric-value" id="chinaRepairCount">0</div>
                        <div class="metric-change positive">Active repair system</div>
                    </div>
                </div>

                <div class="tab-content" id="china-tab-2">
                    <div class="explanation-box">
                        <h4>üìà What These Metrics Show</h4>
                        <p>Concrete, measurable outcomes of institutional design. Watch life expectancy rise, poverty fall, and homeownership 
                        spread. These aren't abstractions‚Äîthey represent hundreds of millions of lives improved.</p>
                    </div>
                    <h3>Key Outcome Metrics</h3>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Life Expectancy</div>
                            <div class="metric-value" id="chinaLifeExpectancy">66</div>
                            <div class="metric-change" id="chinaLifeChange">years</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Poverty Rate</div>
                            <div class="metric-value" id="chinaPoverty">88%</div>
                            <div class="metric-change" id="chinaPovertyChange">(&lt;$1.90/day)</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Home Ownership</div>
                            <div class="metric-value" id="chinaHomeOwnership">~0%</div>
                            <div class="metric-change" id="chinaHomeChange">collectivized</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Optimism Index</div>
                            <div class="metric-value" id="chinaOptimism">--</div>
                            <div class="metric-change" id="chinaOptimismChange">recovering from trauma</div>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 30px;">Morphic Fidelity 
                        <span class="tooltip-icon" data-tooltip="How well policy responses match population needs (0-100%)">?</span>
                    </h3>
                    <div class="explanation-box">
                        <h4>üéØ What This Gauge Shows</h4>
                        <p><strong>Morphic fidelity</strong> measures whether policy responses <em>match the shape</em> of population needs. 
                        High score = when people need help, they get it. Low score = policy ignores or worsens problems. Watch China's score 
                        improve as policies align with citizen needs.</p>
                    </div>
                    <div class="fidelity-gauge">
                        <div class="gauge-circle" id="chinaFidelityGauge" style="--percentage: 0%">
                            <div class="gauge-inner">
                                <div class="gauge-value" id="chinaFidelityValue">0%</div>
                                <div class="gauge-label">Pattern Match</div>
                            </div>
                        </div>
                        <p><strong>Policy shape matches population need shape</strong></p>
                    </div>
                </div>

                <div class="tab-content" id="china-tab-3">
                    <div class="explanation-box">
                        <h4>üë§ What This Story Shows</h4>
                        <p>Abstract statistics come from real lives. Wang Li represents millions who experienced similar trajectories: 
                        subsistence farmer ‚Üí factory worker ‚Üí middle-class homeowner. Watch how institutional changes create personal opportunities.</p>
                    </div>
                    <div class="agent-story">
                        <h4>Agent #47: Wang Li (Rural ‚Üí Urban)</h4>
                        <div id="chinaAgentStory">
                            <div class="story-event">
                                <strong>1978:</strong> Subsistence farmer, Anhui Province
                                <span class="coherence-badge coherence-low">Coherence: 0.12</span>
                                <p style="margin-top: 5px; color: #666;">Barely surviving, widespread hunger</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- US PANEL -->
            <div class="panel panel-us">
                <h2>üá∫üá∏ United States: Extractive Capitalism</h2>
                
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('us', 0)">Coherence</button>
                    <button class="tab" onclick="switchTab('us', 1)">Repair Loops</button>
                    <button class="tab" onclick="switchTab('us', 2)">Metrics</button>
                    <button class="tab" onclick="switchTab('us', 3)">Agent Story</button>
                </div>

                <div class="tab-content active" id="us-tab-0">
                    <div class="explanation-box">
                        <h4>üìä What This Chart Shows</h4>
                        <p>This line graph tracks US population coherence declining from 0.70 (strong middle class) to 0.35 (widespread precarity). 
                        This represents the "hollowing out" of the American working class‚Äîstable jobs replaced by gig economy, security replaced by stress.</p>
                    </div>
                    <div class="chart-container">
                        <canvas id="usCoherenceChart"></canvas>
                    </div>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">
                                Average Coherence
                                <span class="tooltip-icon" data-tooltip="0-1 scale: Higher = more secure & integrated">?</span>
                            </div>
                            <div class="metric-value" id="usAvgCoherence">0.70</div>
                            <div class="metric-change" id="usCoherenceChange">Starting...</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">
                                Bottom 50% Coherence
                                <span class="tooltip-icon" data-tooltip="Poorest half of population's well-being">?</span>
                            </div>
                            <div class="metric-value" id="usBottom50">0.68</div>
                            <div class="metric-change" id="usBottom50Change">Stable middle class</div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="us-tab-1">
                    <div class="explanation-box">
                        <h4>üö´ What This Heatmap Shows</h4>
                        <p>Notice how few colored bars appear‚Äîespecially after 1980. This shows <strong>blocked repair loops</strong>. 
                        When US workers faced stress (job loss, wage stagnation), institutional responses were minimal or absent. 
                        Compare this sparse pattern to China's frequent activations.</p>
                    </div>
                    <h3>Repair Loop Activations</h3>
                    <div class="heatmap">
                        <div class="heatmap-row">
                            <div class="heatmap-label">Institutional</div>
                            <div class="heatmap-bars" id="usInstitutionalBars"></div>
                        </div>
                        <div class="heatmap-row">
                            <div class="heatmap-label">Civic</div>
                            <div class="heatmap-bars" id="usCivicBars"></div>
                        </div>
                        <div class="heatmap-row">
                            <div class="heatmap-label">BioBond</div>
                            <div class="heatmap-bars" id="usBioBondBars"></div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Total Repair Activations</div>
                        <div class="metric-value" id="usRepairCount">0</div>
                        <div class="metric-change negative">Blocked repair system</div>
                    </div>
                </div>

                <div class="tab-content" id="us-tab-2">
                    <div class="explanation-box">
                        <h4>üìâ What These Metrics Show</h4>
                        <p>Watch how measures of security decline or stagnate. Life expectancy reverses (unprecedented for developed nation at peace). 
                        "Deep poverty" emerges‚ÄîAmericans living on less than $2/day, a condition associated with developing nations. Union membership 
                        collapses, removing worker power.</p>
                    </div>
                    <h3>Key Outcome Metrics</h3>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Life Expectancy</div>
                            <div class="metric-value" id="usLifeExpectancy">71</div>
                            <div class="metric-change" id="usLifeChange">years (rising)</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Deep Poverty</div>
                            <div class="metric-value" id="usPoverty">~0%</div>
                            <div class="metric-change" id="usPovertyChange">(&lt;$2/day)</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Home Ownership</div>
                            <div class="metric-value" id="usHomeOwnership">65%</div>
                            <div class="metric-change" id="usHomeChange">stable</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Worker Power</div>
                            <div class="metric-value" id="usUnionization">24%</div>
                            <div class="metric-change" id="usUnionChange">union membership</div>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 30px;">Morphic Fidelity 
                        <span class="tooltip-icon" data-tooltip="How well policy responses match population needs (0-100%)">?</span>
                    </h3>
                    <div class="explanation-box">
                        <h4>‚ö†Ô∏è What This Gauge Shows</h4>
                        <p>Watch US morphic fidelity <strong>decline</strong>‚Äîpolicy responses increasingly <em>oppose</em> population needs. 
                        When workers need higher wages, policy allows stock buybacks (profits to shareholders). When people need safety nets, 
                        welfare is cut. Low fidelity = system working against citizens.</p>
                    </div>
                    <div class="fidelity-gauge">
                        <div class="gauge-circle" id="usFidelityGauge" style="--percentage: 0%">
                            <div class="gauge-inner">
                                <div class="gauge-value" id="usFidelityValue">0%</div>
                                <div class="gauge-label">Pattern Match</div>
                            </div>
                        </div>
                        <p><strong>Policy shape opposes population need shape</strong></p>
                    </div>
                </div>

                <div class="tab-content" id="us-tab-3">
                    <div class="explanation-box">
                        <h4>üë§ What This Story Shows</h4>
                        <p>The Johnson family represents millions who experienced downward mobility: union factory worker ‚Üí service job ‚Üí 
                        gig economy. Watch how institutional changes destroy opportunities. Same country, same work ethic, opposite trajectory 
                        from their 1973 starting point.</p>
                    </div>
                    <div class="agent-story">
                        <h4>Agent #23: Johnson Family (Manufacturing)</h4>
                        <div id="usAgentStory">
                            <div class="story-event">
                                <strong>1973:</strong> Union factory worker, Detroit
                                <span class="coherence-badge coherence-high">Coherence: 0.75</span>
                                <p style="margin-top: 5px; color: #666;">Stable middle class, pension, benefits</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="comparison-section">
            <h2 style="text-align: center; margin-bottom: 30px;">üìä Side-by-Side Comparison</h2>
            <div class="explanation-box">
                <h4>üîç What This Table Shows</h4>
                <p>Direct comparison of identical metrics. Notice the <strong>inversion</strong>: China starts worse on almost every measure, 
                ends better. US starts strong, ends with decline. Same economic tools, opposite institutional designs, opposite outcomes.</p>
            </div>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>üá®üá≥ China</th>
                        <th>üá∫üá∏ United States</th>
                    </tr>
                </thead>
                <tbody id="comparisonTableBody">
                    <tr>
                        <td>Avg Coherence (Current)</td>
                        <td id="compChinaCoherence">0.15</td>
                        <td id="compUSCoherence">0.70</td>
                    </tr>
                    <tr>
                        <td>Trajectory</td>
                        <td id="compChinaTrend">Starting...</td>
                        <td id="compUSTrend">Starting...</td>
                    </tr>
                    <tr>
                        <td>Repair Loops Active</td>
                        <td id="compChinaRepair">0</td>
                        <td id="compUSRepair">0</td>
                    </tr>
                    <tr>
                        <td>Morphic Fidelity</td>
                        <td id="compChinaFidelity">--</td>
                        <td id="compUSFidelity">--</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="reflection-section">
            <h2 style="text-align: center; margin-bottom: 20px;">üí≠ Reflection Questions</h2>
            <p style="text-align: center; margin-bottom: 30px; font-size: 1.1em;">
                Take time to think deeply about what you observed. These questions help you connect the simulation to real life.
            </p>
            <div class="reflection-question">
                <h4>1. Where did you see the Morphic Constraint working (China) vs. violated (US)?</h4>
                <p style="color: #666; font-size: 14px; margin: 5px 0;">Hint: Look at when population needs arose and whether policy responses matched those needs.</p>
                <textarea id="reflection1" placeholder="Type your response here..."></textarea>
            </div>
            <div class="reflection-question">
                <h4>2. At what point did the US cross the coherence threshold where self-repair became impossible?</h4>
                <p style="color: #666; font-size: 14px; margin: 5px 0;">Hint: Look at when the coherence line dropped below ~0.35 and repair loops stopped activating.</p>
                <textarea id="reflection2" placeholder="Type your response here..."></textarea>
            </div>
            <div class="reflection-question">
                <h4>3. Which specific policy differences had the biggest impact on outcomes?</h4>
                <p style="color: #666; font-size: 14px; margin: 5px 0;">Hint: Think about infrastructure investment, safety nets, capital discipline, worker power.</p>
                <textarea id="reflection3" placeholder="Type your response here..."></textarea>
            </div>
            <div class="reflection-question">
                <h4>4. How does this connect to your own workplace or school? Metabolic or extractive?</h4>
                <p style="color: #666; font-size: 14px; margin: 5px 0;">Hint: Does your institution invest in your development or extract your energy? Are there repair mechanisms when you're stressed?</p>
                <textarea id="reflection4" placeholder="Type your response here..."></textarea>
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn-primary" onclick="exportReflections()" style="padding: 15px 40px;">üì• Export Responses</button>
            </div>
        </div>
    </div>

    <script>
        // Simulation State
        let simulationState = {
            running: false,
            currentYear: 0,
            startYear: 1973,
            china: {
                agents: [],
                avgCoherence: 0.15,
                repairCount: 0,
                metrics: {}
            },
            us: {
                agents: [],
                avgCoherence: 0.70,
                repairCount: 0,
                metrics: {}
            }
        };

        let chinaChart, usChart;
        let animationInterval;

        // Show intro modal on first load
        window.addEventListener('load', () => {
            const hasSeenIntro = localStorage.getItem('hasSeenIntro');
            if (!hasSeenIntro) {
                openModal('intro');
                localStorage.setItem('hasSeenIntro', 'true');
            }
            initCharts();
            initHeatmaps();
            updateCharts(0);
        });

        // Modal Functions
        function openModal(type) {
            document.getElementById(type + 'Modal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeModal(type) {
            document.getElementById(type + 'Modal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function openGlossaryTerm(term) {
            openModal('glossary');
            // Scroll to specific term
            setTimeout(() => {
                const termMap = {
                    'metabolic': 2,
                    'extractive': 3,
                    'coherence': 4,
                    'morphic': 6
                };
                const terms = document.querySelectorAll('.glossary-term');
                if (termMap[term] && terms[termMap[term]]) {
                    terms[termMap[term]].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    terms[termMap[term]].style.background = '#fff9c4';
                    setTimeout(() => {
                        terms[termMap[term]].style.background = '#f8f9fa';
                    }, 2000);
                }
            }, 300);
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        };

        // Initialize Charts
        function initCharts() {
            const chinaCtx = document.getElementById('chinaCoherenceChart').getContext('2d');
            const usCtx = document.getElementById('usCoherenceChart').getContext('2d');

            const chartConfig = (title, color) => ({
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Population Average',
                        data: [],
                        borderColor: color,
                        backgroundColor: color + '33',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: title,
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: true,
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            min: 0,
                            max: 1,
                            title: {
                                display: true,
                                text: 'Coherence Score (0-1)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Year'
                            }
                        }
                    }
                }
            });

            chinaChart = new Chart(chinaCtx, chartConfig('PRF Coherence Trajectory', '#ff6b00'));
            usChart = new Chart(usCtx, chartConfig('PRF Coherence Trajectory', '#1976d2'));
        }

        // Initialize Heatmap Bars
        function initHeatmaps() {
            const createBars = (containerId) => {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                for (let i = 0; i < 51; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'heatmap-bar';
                    container.appendChild(bar);
                }
            };

            createBars('chinaInstitutionalBars');
            createBars('chinaCivicBars');
            createBars('chinaBioBondBars');
            createBars('usInstitutionalBars');
            createBars('usCivicBars');
            createBars('usBioBondBars');
        }

        // Simulation Logic
        function calculateChinaCoherence(year) {
            const t = year / 51;
            let coherence = 0.15;
            
            if (t < 0.1) {
                coherence = 0.15;
            } else if (t < 0.3) {
                coherence = 0.15 + (t - 0.1) * 2.0;
            } else if (t < 0.6) {
                coherence = 0.35 + (t - 0.3) * 1.0;
            } else if (t < 0.9) {
                coherence = 0.65 + (t - 0.6) * 0.35;
            } else {
                coherence = 0.75 + (t - 0.9) * 0.0;
            }

            return Math.min(coherence, 0.80);
        }

        function calculateUSCoherence(year) {
            const t = year / 51;
            let coherence = 0.70;
            
            if (t < 0.15) {
                coherence = 0.70 - t * 0.1;
            } else if (t < 0.5) {
                coherence = 0.68 - (t - 0.15) * 0.8;
            } else if (t < 0.8) {
                coherence = 0.40 - (t - 0.5) * 0.3;
            } else {
                coherence = 0.35 - (t - 0.8) * 0.2;
            }

            return Math.max(coherence, 0.25);
        }

        function updateCharts(year) {
            const displayYear = 1973 + year;
            const chinaCoherence = calculateChinaCoherence(year);
            const usCoherence = calculateUSCoherence(year);

            chinaChart.data.labels.push(displayYear);
            chinaChart.data.datasets[0].data.push(chinaCoherence);
            chinaChart.update('none');

            usChart.data.labels.push(displayYear);
            usChart.data.datasets[0].data.push(usCoherence);
            usChart.update('none');

            document.getElementById('chinaAvgCoherence').textContent = chinaCoherence.toFixed(2);
            document.getElementById('usAvgCoherence').textContent = usCoherence.toFixed(2);

            if (year > 0) {
                const chinaChange = ((chinaCoherence - 0.15) / 0.15 * 100).toFixed(0);
                const usChange = ((usCoherence - 0.70) / 0.70 * 100).toFixed(0);
                
                document.getElementById('chinaCoherenceChange').textContent = `+${chinaChange}% from 1978`;
                document.getElementById('chinaCoherenceChange').className = 'metric-change positive';
                
                document.getElementById('usCoherenceChange').textContent = `${usChange}% from 1973`;
                document.getElementById('usCoherenceChange').className = 'metric-change negative';
            }

            updateRepairLoops(year);
            updateMetrics(year);
            updateAgentStories(year);
            updateComparison(year);
        }

        function updateRepairLoops(year) {
            const chinaEvents = [5, 8, 12, 15, 18, 22, 25, 28, 32, 35, 38, 42, 45, 48, 51];
            const usEvents = [2, 5, 48, 50];

            function activateBar(containerId, events, currentYear) {
                const bars = document.querySelectorAll(`#${containerId} .heatmap-bar`);
                events.forEach(eventYear => {
                    if (eventYear <= currentYear && eventYear < bars.length) {
                        bars[eventYear].classList.add('active');
                    }
                });
            }

            activateBar('chinaInstitutionalBars', chinaEvents.filter((_, i) => i % 3 === 0), year);
            activateBar('chinaCivicBars', chinaEvents.filter((_, i) => i % 3 === 1), year);
            activateBar('chinaBioBondBars', chinaEvents.filter((_, i) => i % 3 === 2), year);

            activateBar('usInstitutionalBars', [2, 48, 50], year);
            activateBar('usCivicBars', [2, 5], year);
            activateBar('usBioBondBars', [2], year);

            const chinaCount = chinaEvents.filter(e => e <= year).length;
            const usCount = usEvents.filter(e => e <= year).length;

            document.getElementById('chinaRepairCount').textContent = chinaCount * 56;
            document.getElementById('usRepairCount').textContent = usCount * 18;
        }

        function updateMetrics(year) {
            const t = year / 51;

            const chinaLifeExp = Math.round(66 + t * 12);
            const chinaPoverty = Math.round(88 * (1 - t * 0.99));
            const chinaHome = Math.round(t * 90);
            const chinaOptimism = year > 25 ? '76%' : '--';

            document.getElementById('chinaLifeExpectancy').textContent = chinaLifeExp;
            document.getElementById('chinaPoverty').textContent = chinaPoverty + '%';
            document.getElementById('chinaHomeOwnership').textContent = chinaHome + '%';
            document.getElementById('chinaOptimism').textContent = chinaOptimism;

            const usLifeExp = year < 40 ? Math.round(71 + t * 7) : Math.round(78 - (t - 0.78) * 10);
            const usPoverty = t > 0.4 ? '~1%' : '~0%';
            const usHomeOwn = Math.round(65 - t * 0);
            const usUnion = Math.round(24 - t * 14);

            document.getElementById('usLifeExpectancy').textContent = usLifeExp;
            document.getElementById('usPoverty').textContent = usPoverty;
            document.getElementById('usHomeOwnership').textContent = usHomeOwn + '%';
            document.getElementById('usUnionization').textContent = usUnion + '%';

            const chinaFidelity = Math.min(20 + year * 1.2, 78);
            const usFidelity = Math.max(65 - year * 0.8, 23);

            updateFidelityGauge('china', chinaFidelity);
            updateFidelityGauge('us', usFidelity);
        }

        function updateFidelityGauge(country, percentage) {
            const gauge = document.getElementById(`${country}FidelityGauge`);
            const value = document.getElementById(`${country}FidelityValue`);
            
            gauge.style.setProperty('--percentage', `${percentage}%`);
            value.textContent = Math.round(percentage) + '%';

            const color = percentage > 60 ? '#4CAF50' : percentage > 40 ? '#ff9800' : '#f44336';
            gauge.style.background = `conic-gradient(from 0deg, ${color} 0%, ${color} ${percentage}%, #ddd ${percentage}%)`;
        }

        function updateAgentStories(year) {
            const chinaStory = document.getElementById('chinaAgentStory');
            if (year >= 10 && !chinaStory.dataset.event1) {
                chinaStory.innerHTML += `
                    <div class="story-event">
                        <strong>1982:</strong> Household Responsibility System ‚Üí sold surplus, income doubled
                        <span class="coherence-badge coherence-medium">Coherence: 0.35</span>
                        <p style="margin-top: 5px; color: #666;">Food secure, able to save</p>
                    </div>
                `;
                chinaStory.dataset.event1 = 'true';
            }
            if (year >= 22 && !chinaStory.dataset.event2) {
                chinaStory.innerHTML += `
                    <div class="story-event">
                        <strong>1995:</strong> Migrated to Shenzhen, factory work
                        <span class="coherence-badge coherence-medium">Coherence: 0.55</span>
                        <p style="margin-top: 5px; color: #666;">Rising middle class, urban life</p>
                    </div>
                `;
                chinaStory.dataset.event2 = 'true';
            }
            if (year >= 42 && !chinaStory.dataset.event3) {
                chinaStory.innerHTML += `
                    <div class="story-event">
                        <strong>2015:</strong> Bought apartment, skilled worker
                        <span class="coherence-badge coherence-high">Coherence: 0.75</span>
                        <p style="margin-top: 5px; color: #666;">Secure middle class, asset owner</p>
                    </div>
                `;
                chinaStory.dataset.event3 = 'true';
            }

            const usStory = document.getElementById('usAgentStory');
            if (year >= 15 && !usStory.dataset.event1) {
                usStory.innerHTML += `
                    <div class="story-event">
                        <strong>1988:</strong> Plant downsizing begins, growing anxiety
                        <span class="coherence-badge coherence-medium">Coherence: 0.58</span>
                        <p style="margin-top: 5px; color: #666;">Job less secure, benefits threatened</p>
                    </div>
                `;
                usStory.dataset.event1 = 'true';
            }
            if (year >= 25 && !usStory.dataset.event2) {
                usStory.innerHTML += `
                    <div class="story-event">
                        <strong>1998:</strong> Plant closed, moved to service work
                        <span class="coherence-badge coherence-medium">Coherence: 0.40</span>
                        <p style="margin-top: 5px; color: #666;">Wages down, no benefits, unstable</p>
                    </div>
                `;
                usStory.dataset.event2 = 'true';
            }
            if (year >= 40 && !usStory.dataset.event3) {
                usStory.innerHTML += `
                    <div class="story-event">
                        <strong>2013:</strong> Gig economy, severe financial stress
                        <span class="coherence-badge coherence-low">Coherence: 0.22</span>
                        <p style="margin-top: 5px; color: #666;">Can't cover emergencies, precarious survival</p>
                    </div>
                `;
                usStory.dataset.event3 = 'true';
            }
        }

        function updateComparison(year) {
            const chinaCoherence = calculateChinaCoherence(year);
            const usCoherence = calculateUSCoherence(year);

            document.getElementById('compChinaCoherence').textContent = chinaCoherence.toFixed(2);
            document.getElementById('compUSCoherence').textContent = usCoherence.toFixed(2);

            const chinaChange = ((chinaCoherence - 0.15) / 0.15 * 100).toFixed(0);
            const usChange = ((usCoherence - 0.70) / 0.70 * 100).toFixed(0);

            document.getElementById('compChinaTrend').textContent = `‚Üë +${chinaChange}%`;
            document.getElementById('compUSTrend').textContent = `‚Üì ${usChange}%`;

            const chinaRepair = parseInt(document.getElementById('chinaRepairCount').textContent);
            const usRepair = parseInt(document.getElementById('usRepairCount').textContent);

            document.getElementById('compChinaRepair').textContent = chinaRepair + ' (HIGH)';
            document.getElementById('compUSRepair').textContent = usRepair + ' (BLOCKED)';

            const chinaFidelity = Math.min(20 + year * 1.2, 78);
            const usFidelity = Math.max(65 - year * 0.8, 23);

            document.getElementById('compChinaFidelity').textContent = Math.round(chinaFidelity) + '% (GOOD)';
            document.getElementById('compUSFidelity').textContent = Math.round(usFidelity) + '% (POOR)';
        }

        // Control Functions
        function runSimulation() {
            simulationState.running = true;
            document.getElementById('runBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('yearSlider').disabled = true;
            document.getElementById('statusIndicator').className = 'status-indicator status-running';
            document.getElementById('statusText').textContent = 'Running...';

            const speed = parseInt(document.getElementById('speedSelect').value);

            animationInterval = setInterval(() => {
                if (simulationState.currentYear >= 51) {
                    pauseSimulation();
                    document.getElementById('statusText').textContent = 'Complete!';
                    document.getElementById('statusIndicator').className = 'status-indicator';
                    return;
                }

                simulationState.currentYear++;
                document.getElementById('currentYear').textContent = 1973 + simulationState.currentYear;
                document.getElementById('yearSlider').value = simulationState.currentYear;
                
                updateCharts(simulationState.currentYear);
            }, speed);
        }

        function pauseSimulation() {
            simulationState.running = false;
            clearInterval(animationInterval);
            document.getElementById('runBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('statusIndicator').className = 'status-indicator status-paused';
            document.getElementById('statusText').textContent = 'Paused';
        }

        function resetSimulation() {
            pauseSimulation();
            simulationState.currentYear = 0;
            document.getElementById('currentYear').textContent = '1973';
            document.getElementById('yearSlider').value = 0;
            document.getElementById('statusIndicator').className = 'status-indicator';
            document.getElementById('statusText').textContent = 'Ready';
            document.getElementById('yearSlider').disabled = false;

            chinaChart.data.labels = [];
            chinaChart.data.datasets[0].data = [];
            chinaChart.update();

            usChart.data.labels = [];
            usChart.data.datasets[0].data = [];
            usChart.update();

            document.getElementById('chinaAvgCoherence').textContent = '0.15';
            document.getElementById('usAvgCoherence').textContent = '0.70';
            document.getElementById('chinaCoherenceChange').textContent = 'Starting...';
            document.getElementById('usCoherenceChange').textContent = 'Starting...';

            initHeatmaps();

            document.getElementById('chinaRepairCount').textContent = '0';
            document.getElementById('usRepairCount').textContent = '0';

            document.getElementById('chinaAgentStory').innerHTML = `
                <div class="story-event">
                    <strong>1978:</strong> Subsistence farmer, Anhui Province
                    <span class="coherence-badge coherence-low">Coherence: 0.12</span>
                    <p style="margin-top: 5px; color: #666;">Barely surviving, widespread hunger</p>
                </div>
            `;
            document.getElementById('chinaAgentStory').removeAttribute('data-event1');
            document.getElementById('chinaAgentStory').removeAttribute('data-event2');
            document.getElementById('chinaAgentStory').removeAttribute('data-event3');

            document.getElementById('usAgentStory').innerHTML = `
                <div class="story-event">
                    <strong>1973:</strong> Union factory worker, Detroit
                    <span class="coherence-badge coherence-high">Coherence: 0.75</span>
                    <p style="margin-top: 5px; color: #666;">Stable middle class, pension, benefits</p>
                </div>
            `;
            document.getElementById('usAgentStory').removeAttribute('data-event1');
            document.getElementById('usAgentStory').removeAttribute('data-event2');
            document.getElementById('usAgentStory').removeAttribute('data-event3');
        }

        function switchTab(country, tabIndex) {
            const tabs = document.querySelectorAll(`.panel-${country} .tab`);
            tabs.forEach((tab, i) => {
                if (i === tabIndex) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            const contents = document.querySelectorAll(`.panel-${country} .tab-content`);
            contents.forEach((content, i) => {
                if (i === tabIndex) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }

        function exportReflections() {
            const reflections = {
                timestamp: new Date().toISOString(),
                question1: document.getElementById('reflection1').value,
                question2: document.getElementById('reflection2').value,
                question3: document.getElementById('reflection3').value,
                question4: document.getElementById('reflection4').value
            };

            const blob = new Blob([JSON.stringify(reflections, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `great_inversion_reflections_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            alert('‚úÖ Your reflections have been exported! Check your downloads folder.');
        }

        document.getElementById('yearSlider').addEventListener('input', (e) => {
            if (!simulationState.running) {
                const year = parseInt(e.target.value);
                simulationState.currentYear = year;
                document.getElementById('currentYear').textContent = 1973 + year;
                
                chinaChart.data.labels = [];
                chinaChart.data.datasets[0].data = [];
                usChart.data.labels = [];
                usChart.data.datasets[0].data = [];

                for (let i = 0; i <= year; i++) {
                    updateCharts(i);
                }
            }
        });
    </script>
</body>
</html>
